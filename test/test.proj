<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Test" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup>
    <Configuration Condition="'$(Configuration)' == ''">Debug</Configuration>
    <TargetPath>$(MSBuildProjectDirectory)\..\$(Configuration)</TargetPath>
  </PropertyGroup>
  <ItemGroup>
    <TestScript Include="field.xm" />
    <TestScript Include="flow.xm" />
    <TestScript Include="flow2.xm" />
    <TestScript Include="primitives.xm" />
    <TestScript Include="race.xm" />
    <TestScript Include="ring.xm" />
    <TestScript Include="symbol.xm" />
    <TestScript Include="fiber.xm" />
    <TestScript Include="fiber2.xm" />
    <TestScript Include="fiber3.xm" />
    <TestScript Include="thread.xm" />
    <TestScript Include="threading.xm" />
    <TestScript Include="tuple.xm" />
    <TestScript Include="variadic.xm" />
    <TestScript Include="array.xm" />
    <TestScript Include="dictionary.xm" />
    <TestScript Include="bytes.xm" />
    <TestScript Include="file.xm" />
    <TestScript Include="text.xm" />
    <TestScript Include="path.xm" />
    <TestScript Include="hanoi.xm" />
    <TestScript Include="hanoi2.xm" />
    <TestScript Include="prime.xm" />
    <TestScript Include="prime2.xm" />
    <TestScript Include="prime3.xm" />
    <TestScript Include="psmtp.xm" />
    <TestScript Include="mandelbrot.xm" />
    <TestScript Include="fix.xm" />
    <TestScript Include="container\test.xm">
      <InFile>true</InFile>
    </TestScript>
    <TestScript Include="callback\test.xm">
      <InFile>true</InFile>
    </TestScript>
  </ItemGroup>
  <Target Name="BuildSolution">
    <MSBuild Projects="..\xemmai.sln" Properties="Configuration=$(Configuration)" />
  </Target>
  <Target Name="RunTest" DependsOnTargets="BuildSolution" Returns="%(TestScript.Identity)">
    <Copy Condition="'%(TestScript.InFile)' == 'true'" SourceFiles="%(TestScript.Identity).in" DestinationFiles="%(TestScript.Identity)" />
    <Exec Command="set XEMMAI_MODULE_PATH=&quot;$(TargetPath)&quot; &amp;&amp; &quot;$(TargetPath)\xemmai&quot; --verbose %(TestScript.Identity)" ContinueOnError="true">
      <Output TaskParameter="ExitCode" PropertyName="TestExitCode" />
    </Exec>
    <ItemGroup>
      <TestFailed Condition="$(TestExitCode) != 0" Include="%(TestScript.Identity)" />
    </ItemGroup>
  </Target>
  <Target Name="Test" DependsOnTargets="RunTest">
    <Error Condition="'@(TestFailed)' != ''" Text="FAILED: @(TestFailed)" />
  </Target>
</Project>
